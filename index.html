<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TÃ¤gliche Quiz Runde</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;background:#141019;color:#f2ebff;font-family:system-ui,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .top{background:#251a30;border:2px solid #4e3a63;border-radius:14px;padding:12px;text-align:center}
    .title{font-size:34px;font-weight:900;color:#e3c47f}
    .btn{padding:10px 14px;border-radius:10px;border:2px solid #5c4474;background:#332447;color:#fff;font-weight:700;cursor:pointer}
    .btn.green{background:#2d8a4d;border-color:#4ac26d}
    .btn.cta{font-size:18px;padding:13px 22px;min-width:170px}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .card{background:#23192c;border:2px solid #3b2b4a;border-radius:14px;padding:12px;margin-top:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
    .char{border:2px solid #56406d;border-radius:10px;padding:10px;text-align:center;cursor:pointer;background:#1a1321}
    .char.active{border-color:#e3c47f}
    .char.taken{opacity:.7}
    .leader li{display:flex;justify-content:space-between;border-bottom:1px dashed #4c3961;padding:6px 0}
    #quiz{display:none}
    .timer{height:10px;background:#261d31;border:1px solid #584170;border-radius:999px;overflow:hidden;margin:8px 0}
    .timer>div{height:100%;background:linear-gradient(90deg,#4fd475,#d2f27a);width:100%}
    .opt{display:block;width:100%;text-align:left;margin:8px 0}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top"><div class="title">ðŸ§  TÃ¤gliche Quiz Runde</div></div>

    <section id="home" class="card">
      <h3>Spieler auswÃ¤hlen</h3>
      <div id="chars" class="grid"></div>
      <div style="margin-top:10px;display:flex;justify-content:center"><button class="btn green cta" onclick="enterQuiz()">Letâ€™s go</button></div>

      <h3>Leaderboard</h3>
      <ul id="leaderboard" class="leader"></ul>
    </section>

    <section id="quiz" class="card">
      <div class="row">
        <h3 id="qtitle">Frage 1/3</h3>
        <div id="timerText">20s</div>
      </div>
      <div class="timer"><div id="tbar"></div></div>
      <p id="qprompt"></p>
      <div id="qopts"></div>
      <p id="qresult"></p>
      <div class="row" style="margin-top:12px">
        <span id="progressLabel"></span>
        <button id="nextBtn" class="btn" disabled onclick="nextStep()">Weiter</button>
        <button id="homeBtn" class="btn" style="display:none" disabled onclick="backHome()">Zur Startseite</button>
      </div>
    </section>
  </div>
<script>
let selectedCharacter=null;
let timerInt=null;
let left=20;
let answered=false;
let currentIndex=0;
let totalQuestions=3;

async function boot(){
  const r=await fetch('/api/bootstrap'); const d=await r.json();
  const chars=document.getElementById('chars'); chars.innerHTML='';
  d.characters.forEach(c=>{
    const taken=d.taken.includes(c);
    const el=document.createElement('div');
    el.className='char'+(taken?' taken':'');
    el.textContent=c;
    el.onclick=()=>{selectedCharacter=c; [...chars.children].forEach(x=>x.classList.remove('active')); el.classList.add('active');};
    chars.appendChild(el);
  });
  const lb=document.getElementById('leaderboard');
  lb.innerHTML = d.leaderboard.length ? d.leaderboard.map(x=>`<li><span>${x.character}</span><b>${x.points} pts</b></li>`).join('') : '<li>No points yet.</li>';
}

async function enterQuiz(){
  if(!selectedCharacter) return alert('Bitte Spieler auswÃ¤hlen');

  // try login first, if not existing then register
  let r=await fetch('/api/login',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({character:selectedCharacter})});
  if(!r.ok){
    r=await fetch('/api/register',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({character:selectedCharacter})});
    const d2=await r.json();
    if(!r.ok) return alert(d2.error||'Fehler');
  }

  document.getElementById('home').style.display='none';
  document.getElementById('quiz').style.display='block';
  await loadQuestion(0);
}

async function loadQuestion(index){
  clearInterval(timerInt);
  answered=false;
  left=20;
  document.getElementById('nextBtn').disabled=true;
  document.getElementById('homeBtn').disabled=true;
  document.getElementById('qresult').textContent='';

  const r=await fetch('/api/question-today?character='+encodeURIComponent(selectedCharacter)+'&questionIndex='+index);
  const d=await r.json();
  if(!r.ok) return alert(d.error||'Fragefehler');

  currentIndex=Number(d.questionIndex||0);
  totalQuestions=Number(d.totalQuestions||3);

  document.getElementById('qtitle').textContent=`Frage ${currentIndex+1}/${totalQuestions}`;
  document.getElementById('qprompt').textContent=d.question.prompt;
  document.getElementById('progressLabel').textContent=`Beantwortet: ${d.progress.answeredCount}/${totalQuestions}`;

  const qopts=document.getElementById('qopts'); qopts.innerHTML='';
  d.question.options.forEach((o,i)=>{
    const b=document.createElement('button');
    b.className='btn opt';
    b.textContent=o;
    b.onclick=()=>submitAnswer(i,false);
    qopts.appendChild(b);
  });

  const finished = Boolean(d.finished);
  document.getElementById('nextBtn').style.display = (!finished && currentIndex < totalQuestions-1) ? 'inline-block' : 'none';
  document.getElementById('homeBtn').style.display = (finished || currentIndex === totalQuestions-1) ? 'inline-block' : 'none';

  if (finished) {
    lockOptions();
    document.getElementById('qresult').textContent='Heute bereits alle 3 Fragen beantwortet. Morgen ab 08:30 gibt es neue Fragen.';
    document.getElementById('homeBtn').disabled=false;
    return;
  }

  runTimer();
}

function runTimer(){
  clearInterval(timerInt);
  const bar=document.getElementById('tbar');
  document.getElementById('timerText').textContent='20s';
  bar.style.width='100%';
  timerInt=setInterval(()=>{
    left--;
    document.getElementById('timerText').textContent=left+'s';
    bar.style.width=Math.max(0,(left/20)*100)+'%';
    if(left<=0){ clearInterval(timerInt); if(!answered){ submitAnswer(-1,true); }}
  },1000);
}

function lockOptions(correctIndex = null, chosenIndex = null){
  [...document.querySelectorAll('#qopts .opt')].forEach((b,i)=>{
    b.disabled = true;
    if(correctIndex !== null && i===correctIndex){
      b.classList.add('green');
    } else if(chosenIndex !== null && i===chosenIndex){
      b.style.background = '#6a1f2e';
      b.style.borderColor = '#d94f64';
    }
  });
}

async function submitAnswer(choiceIndex, timedOut){
  if(answered) return;
  answered=true;
  clearInterval(timerInt);

  const r=await fetch('/api/answer',{
    method:'POST',
    headers:{'content-type':'application/json'},
    body:JSON.stringify({
      character:selectedCharacter,
      questionIndex:currentIndex,
      choiceIndex,
      timedOut
    })
  });
  const d=await r.json();
  if(!r.ok){
    document.getElementById('qresult').textContent=d.error||'Fehler';
    lockOptions();
    document.getElementById('nextBtn').disabled=false;
    document.getElementById('homeBtn').disabled=false;
    return;
  }

  lockOptions(Number(d.correctIndex), timedOut ? null : choiceIndex);

  if (timedOut) {
    document.getElementById('qresult').textContent='Zeit abgelaufen â€“ kein Punkt. Richtige Antwort ist markiert.';
  } else if (d.isCorrect) {
    document.getElementById('qresult').textContent=`Richtig! +1 Punkt (Gesamt: ${d.points})`;
  } else {
    document.getElementById('qresult').textContent='Falsch â€“ kein Punkt. Richtige Antwort ist markiert.';
  }

  document.getElementById('progressLabel').textContent=`Beantwortet: ${d.answeredCount}/${totalQuestions}`;

  const isLastQuestion = currentIndex >= totalQuestions - 1;
  if (!isLastQuestion && !d.roundFinished) {
    document.getElementById('nextBtn').disabled=false;
  } else {
    document.getElementById('homeBtn').disabled=false;
  }

  await boot();
}

function nextStep(){
  if(document.getElementById('nextBtn').disabled) return;
  loadQuestion(currentIndex + 1);
}

function backHome(){
  if(document.getElementById('homeBtn').disabled) return;
  clearInterval(timerInt);
  document.getElementById('quiz').style.display='none';
  document.getElementById('home').style.display='block';
  boot();
}

boot();
</script>
</body>
</html>
